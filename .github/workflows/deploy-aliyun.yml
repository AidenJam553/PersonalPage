name: Deploy to Aliyun OSS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci || npm install
      
      - name: Build project
        run: |
          echo "Building project..."
          ls -la node_modules/.bin/ || echo "node_modules/.bin not found"
          npx vite build
          echo "âœ… Build completed"
      
      - name: Setup Python for OSS SDK
        run: |
          python3 --version
          pip3 install oss2
      
      - name: Deploy to OSS using Python SDK
        env:
          OSS_ENDPOINT: ${{ secrets.ALIYUN_OSS_ENDPOINT }}
          OSS_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          OSS_BUCKET: ${{ secrets.ALIYUN_OSS_BUCKET }}
        run: |
          python3 << 'EOF'
          import os
          import oss2
          from pathlib import Path
          import mimetypes
          
          endpoint = os.environ['OSS_ENDPOINT']
          access_key_id = os.environ['OSS_ACCESS_KEY_ID']
          access_key_secret = os.environ['OSS_ACCESS_KEY_SECRET']
          bucket_name = os.environ['OSS_BUCKET']
          
          print(f"Connecting to OSS: {bucket_name} at {endpoint}")
          auth = oss2.Auth(access_key_id, access_key_secret)
          bucket = oss2.Bucket(auth, endpoint, bucket_name)
          
          # Check bucket ACL (permissions)
          try:
              acl = bucket.get_bucket_acl().acl
              print(f"ðŸ“‹ Bucket ACL: {acl}")
              if acl != oss2.BUCKET_ACL_PUBLIC_READ:
                  print("âš ï¸ Warning: Bucket is not set to PUBLIC_READ!")
                  print("   Please set bucket ACL to 'å…¬å…±è¯»' in OSS console:")
                  print("   Permission Control â†’ Read/Write Permissions â†’ Public Read")
          except Exception as e:
              print(f"âš ï¸ Could not check bucket ACL: {e}")
          
          dist_path = Path('dist')
          if not dist_path.exists():
              print("âŒ Error: dist directory not found!")
              exit(1)
          
          # MIME type mapping
          mime_types = {
              '.html': 'text/html; charset=utf-8',
              '.js': 'application/javascript; charset=utf-8',
              '.css': 'text/css; charset=utf-8',
              '.json': 'application/json',
              '.png': 'image/png',
              '.jpg': 'image/jpeg',
              '.jpeg': 'image/jpeg',
              '.gif': 'image/gif',
              '.svg': 'image/svg+xml',
              '.ico': 'image/x-icon',
              '.woff': 'font/woff',
              '.woff2': 'font/woff2',
              '.ttf': 'font/ttf',
              '.eot': 'application/vnd.ms-fontobject'
          }
          
          def get_content_type(file_path):
              suffix = file_path.suffix.lower()
              return mime_types.get(suffix, mimetypes.guess_type(str(file_path))[0] or 'application/octet-stream')
          
          print("\nðŸ“¤ Uploading files...")
          uploaded_files = []
          for file_path in dist_path.rglob('*'):
              if file_path.is_file():
                  object_name = file_path.relative_to(dist_path).as_posix()
                  object_name = object_name.replace('\\', '/')
                  content_type = get_content_type(file_path)
                  
                  # Prepare headers
                  headers = {}
                  
                  # Set Content-Type for all files
                  headers['Content-Type'] = content_type
                  
                  # Special handling for HTML files
                  if file_path.suffix.lower() == '.html':
                      headers['Cache-Control'] = 'no-cache'
                      # CRITICAL: Set Content-Disposition to inline to prevent download
                      headers['Content-Disposition'] = 'inline'
                      print(f"  ðŸ“„ {object_name} â†’ Content-Type: {content_type}, Content-Disposition: inline")
                  else:
                      headers['Cache-Control'] = 'public, max-age=31536000'
                      print(f"  ðŸ“„ {object_name} â†’ Content-Type: {content_type}")
                  
                  # Upload with headers
                  bucket.put_object_from_file(
                      object_name,
                      str(file_path),
                      headers=headers
                  )
                  uploaded_files.append(object_name)
          
          # Configure static website hosting
          print("\nðŸŒ Configuring static website hosting...")
          try:
              website_config = oss2.models.BucketWebsite(
                  index_file='index.html',
                  error_file='index.html'
              )
              bucket.put_bucket_website(website_config)
              print("âœ… Static website hosting configured!")
              
              # Verify configuration
              try:
                  website_info = bucket.get_bucket_website()
                  print(f"   Index file: {website_info.index_file}")
                  print(f"   Error file: {website_info.error_file}")
              except:
                  pass
          except Exception as e:
              print(f"âš ï¸ Warning: Could not configure static website hosting: {e}")
              print("   Please configure manually in OSS console:")
              print("   Data Management â†’ Static Page â†’ Enable â†’ Set index.html")
          
          # Verify index.html was uploaded and check headers
          print("\nðŸ” Verifying deployment...")
          try:
              if bucket.object_exists('index.html'):
                  meta = bucket.head_object('index.html')
                  content_type = meta.headers.get('Content-Type', 'Not set')
                  content_disp = meta.headers.get('Content-Disposition', 'Not set')
                  
                  print(f"âœ… index.html exists")
                  print(f"   Content-Type: {content_type}")
                  print(f"   Content-Disposition: {content_disp}")
                  
                  # Validate headers
                  if 'text/html' not in str(content_type).lower():
                      print(f"   âš ï¸ WARNING: Content-Type should be 'text/html'!")
                  if 'inline' not in str(content_disp).lower():
                      print(f"   âš ï¸ WARNING: Content-Disposition should be 'inline'!")
                      print(f"   âš ï¸ This might cause browser to download instead of display!")
                  else:
                      print(f"   âœ… Headers are correct!")
              else:
                  print("âŒ ERROR: index.html not found in bucket!")
          except Exception as e:
              print(f"âš ï¸ Could not verify index.html: {e}")
          
          # Print access URLs with important warnings
          print("\nðŸŒ Access your website:")
          print(f"   âœ… CORRECT URL: http://{bucket_name}.{endpoint}")
          print(f"   âŒ WRONG:      https://{bucket_name}.{endpoint}")
          print(f"   âŒ WRONG:      http://{bucket_name}.{endpoint}/index.html")
          print(f"\n   âš ï¸  CRITICAL: Use HTTP (not HTTPS) and do NOT add /index.html")
          print(f"   âš ï¸  Using HTTPS or adding /index.html will trigger file download!")
          print(f"\nâœ… Deployment completed successfully!")
          EOF
      
      - name: Success message
        run: |
          echo "ðŸš€ Website deployed successfully to Aliyun OSS!"
          echo "ðŸŒ Access your site at: http://${{ secrets.ALIYUN_OSS_BUCKET }}.${{ secrets.ALIYUN_OSS_ENDPOINT }}"
          echo "âš ï¸  Important: Use HTTP (not HTTPS) for OSS static website hosting!"
          echo "âš ï¸  Do NOT add /index.html at the end!"

