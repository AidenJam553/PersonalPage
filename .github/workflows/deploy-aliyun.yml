name: Deploy to Aliyun OSS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Install dependencies
        run: npm install
      
      - name: Build project
        run: npm run build
      
      - name: Setup Aliyun OSS CLI
        run: |
          echo "Step 1: Downloading ossutil..."
          curl -L https://gosspublic.alicdn.com/ossutil/1.7.14/ossutil64 -o ossutil64
          echo "Step 2: Making ossutil executable..."
          chmod +x ossutil64
          echo "Step 3: Moving to /usr/local/bin..."
          sudo mv ossutil64 /usr/local/bin/ossutil
          echo "Step 4: Verifying installation..."
          /usr/local/bin/ossutil --version
          echo "âœ… ossutil installed successfully"
      
      - name: Configure OSS
        env:
          OSS_ENDPOINT: ${{ secrets.ALIYUN_OSS_ENDPOINT }}
          OSS_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          OSS_BUCKET: ${{ secrets.ALIYUN_OSS_BUCKET }}
        run: |
          echo "Configuring OSS credentials..."
          cat > ~/.ossutilconfig << 'EOF_CONFIG'
          [Credentials]
          language=CH
          endpoint=${OSS_ENDPOINT}
          accessKeyID=${OSS_ACCESS_KEY_ID}
          accessKeySecret=${OSS_ACCESS_KEY_SECRET}
          EOF_CONFIG
          sed -i "s|\${OSS_ENDPOINT}|${OSS_ENDPOINT}|g" ~/.ossutilconfig
          sed -i "s|\${OSS_ACCESS_KEY_ID}|${OSS_ACCESS_KEY_ID}|g" ~/.ossutilconfig
          sed -i "s|\${OSS_ACCESS_KEY_SECRET}|${OSS_ACCESS_KEY_SECRET}|g" ~/.ossutilconfig
          echo "Testing OSS connection..."
          /usr/local/bin/ossutil ls oss://${OSS_BUCKET} || echo "Note: Bucket may be empty"
          echo "âœ… OSS configuration completed"
      
      - name: Deploy to OSS
        env:
          OSS_BUCKET: ${{ secrets.ALIYUN_OSS_BUCKET }}
        run: |
          echo "Checking dist directory..."
          ls -la dist/ || (echo "âŒ dist directory not found" && exit 1)
          echo "Uploading files to OSS..."
          /usr/local/bin/ossutil cp -r dist/ oss://${OSS_BUCKET}/ --update --force
          echo "âœ… Deployment completed successfully!"
      
      - name: Success message
        run: |
          echo "ðŸš€ Website deployed successfully to Aliyun OSS!"
          echo "ðŸŒ Access your site at: https://${{ secrets.ALIYUN_OSS_BUCKET }}.oss-cn-beijing.aliyuncs.com"

