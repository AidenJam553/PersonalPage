name: Deploy to Aliyun OSS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci || npm install
      
      - name: Build project
        run: |
          echo "Building project..."
          ls -la node_modules/.bin/ || echo "node_modules/.bin not found"
          npx vite build
          echo "âœ… Build completed"
      
      - name: Setup Python for OSS SDK
        run: |
          python3 --version
          pip3 install oss2
      
      - name: Deploy to OSS using Python SDK
        env:
          OSS_ENDPOINT: ${{ secrets.ALIYUN_OSS_ENDPOINT }}
          OSS_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          OSS_BUCKET: ${{ secrets.ALIYUN_OSS_BUCKET }}
        run: |
          python3 << 'EOF'
          import os
          import oss2
          from pathlib import Path
          import mimetypes
          
          endpoint = os.environ['OSS_ENDPOINT']
          access_key_id = os.environ['OSS_ACCESS_KEY_ID']
          access_key_secret = os.environ['OSS_ACCESS_KEY_SECRET']
          bucket_name = os.environ['OSS_BUCKET']
          
          print(f"Connecting to OSS: {bucket_name} at {endpoint}")
          auth = oss2.Auth(access_key_id, access_key_secret)
          bucket = oss2.Bucket(auth, endpoint, bucket_name)
          
          dist_path = Path('dist')
          if not dist_path.exists():
              print("âŒ Error: dist directory not found!")
              exit(1)
          
          # MIME type mapping
          mime_types = {
              '.html': 'text/html; charset=utf-8',
              '.js': 'application/javascript; charset=utf-8',
              '.css': 'text/css; charset=utf-8',
              '.json': 'application/json',
              '.png': 'image/png',
              '.jpg': 'image/jpeg',
              '.jpeg': 'image/jpeg',
              '.gif': 'image/gif',
              '.svg': 'image/svg+xml',
              '.ico': 'image/x-icon',
              '.woff': 'font/woff',
              '.woff2': 'font/woff2',
              '.ttf': 'font/ttf',
              '.eot': 'application/vnd.ms-fontobject'
          }
          
          def get_content_type(file_path):
              suffix = file_path.suffix.lower()
              return mime_types.get(suffix, mimetypes.guess_type(str(file_path))[0] or 'application/octet-stream')
          
          print("Uploading files...")
          for file_path in dist_path.rglob('*'):
              if file_path.is_file():
                  object_name = file_path.relative_to(dist_path).as_posix()
                  # Normalize path separators for OSS
                  object_name = object_name.replace('\\', '/')
                  content_type = get_content_type(file_path)
                  
                  # Set headers for HTML files
                  headers = {'Content-Type': content_type}
                  if file_path.suffix.lower() == '.html':
                      headers['Cache-Control'] = 'no-cache'
                  else:
                      headers['Cache-Control'] = 'public, max-age=31536000'
                  
                  print(f"Uploading: {object_name} (Content-Type: {content_type})")
                  bucket.put_object_from_file(
                      object_name,
                      str(file_path),
                      headers=headers
                  )
          
          # Configure static website hosting
          print("Configuring static website hosting...")
          try:
              website_config = oss2.models.BucketWebsite(
                  index_file='index.html',
                  error_file='index.html'
              )
              bucket.put_bucket_website(website_config)
              print("âœ… Static website hosting configured!")
          except Exception as e:
              print(f"âš ï¸ Warning: Could not configure static website hosting: {e}")
              print("Please configure it manually in OSS console:")
              print("  - Default index page: index.html")
              print("  - Default 404 page: index.html")
          
          print("âœ… Deployment completed successfully!")
          EOF
      
      - name: Success message
        run: |
          echo "ðŸš€ Website deployed successfully to Aliyun OSS!"
          echo "ðŸŒ Access your site at: https://${{ secrets.ALIYUN_OSS_BUCKET }}.oss-cn-beijing.aliyuncs.com"

