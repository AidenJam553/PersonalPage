name: Deploy to Aliyun OSS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Install dependencies
        run: npm install
      
      - name: Build project
        run: npm run build
      
      - name: Setup Aliyun OSS CLI
        run: |
          curl -o ossutil64 https://gosspublic.alicdn.com/ossutil/1.7.14/ossutil64
          chmod 755 ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil
          ossutil --version || echo "OSS CLI installed"
      
      - name: Configure OSS
        env:
          OSS_ENDPOINT: ${{ secrets.ALIYUN_OSS_ENDPOINT }}
          OSS_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
        run: |
          mkdir -p ~/.ossutilconfig
          cat > ~/.ossutilconfig << EOF
          [Credentials]
          language=CH
          endpoint=${OSS_ENDPOINT}
          accessKeyID=${OSS_ACCESS_KEY_ID}
          accessKeySecret=${OSS_ACCESS_KEY_SECRET}
          EOF
          ossutil ls oss://${{ secrets.ALIYUN_OSS_BUCKET }} || echo "Configuration completed"
      
      - name: Deploy to OSS
        run: |
          ossutil cp -r ./dist/ oss://${{ secrets.ALIYUN_OSS_BUCKET }}/ --update --force
          echo "âœ… Deployment completed successfully!"
      
      - name: Success message
        run: |
          echo "ðŸš€ Website deployed successfully to Aliyun OSS!"
          echo "ðŸŒ Access your site at: https://${{ secrets.ALIYUN_OSS_BUCKET }}.oss-cn-beijing.aliyuncs.com"

